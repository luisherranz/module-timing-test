<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manual Module Loading Test</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      max-width: 700px;
      margin: 0 auto;
      padding: 20px;
      background: #1a1a2e;
      color: #eee;
    }
    h1 { font-size: 1.2em; margin-bottom: 0.5em; }
    #info {
      font-size: 0.85em;
      color: #888;
      margin-bottom: 1em;
      padding: 10px;
      background: #16213e;
      border-radius: 6px;
    }
    #controls {
      margin-bottom: 1em;
      padding: 12px;
      background: #1e3a5f;
      border-radius: 6px;
    }
    button {
      background: #3498db;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9em;
      margin-right: 10px;
    }
    button:hover { background: #2980b9; }
    button:disabled { background: #555; cursor: not-allowed; }
    #timing-info {
      font-family: "SF Mono", Consolas, monospace;
      font-size: 0.85em;
      margin-bottom: 1em;
      padding: 12px;
      background: #1e3a5f;
      border-radius: 6px;
      border-left: 4px solid #3498db;
    }
    #timing-info .label { color: #888; }
    #timing-info .value { color: #3498db; font-weight: bold; }
    #timing-info .success { color: #2ecc71; }
    #timing-info .warning { color: #e67e22; }
    #log {
      font-family: "SF Mono", Consolas, monospace;
      font-size: 0.9em;
      line-height: 1.6;
      background: #0f0f1a;
      padding: 15px;
      border-radius: 8px;
      min-height: 300px;
    }
    .log-entry {
      padding: 4px 8px;
      border-radius: 4px;
      margin: 2px 0;
    }
    .log-entry:nth-child(odd) { background: rgba(255,255,255,0.03); }
    .sync { color: #3498db; }
    .tla { color: #e67e22; }
    .dom-event { color: #e74c3c; font-weight: bold; }
    .post-task { color: #9b59b6; }
    .detection { color: #2ecc71; font-weight: bold; }
  </style>

  <script type="importmap">
    {
      "imports": {
        "interactivity-api": "./interactivity-api-async.js"
      }
    }
  </script>
</head>
<body>
  <h1>Manual Module Loading Test</h1>
  <div id="info">
    <strong>Browser:</strong> <span id="browser"></span><br>
    <strong>Test:</strong> Manually trigger module import at different document states<br>
    <strong>Goal:</strong> Verify the Navigation Timing API detection works in all scenarios<br>
    <a href="./index.html" style="color:#3498db">Sync test</a> |
    <a href="./async-load-test.html" style="color:#2ecc71">Auto async test</a>
  </div>
  <div id="controls">
    <button id="import-btn">Import Modules Now</button>
    <button id="clear-btn">Clear Log</button>
  </div>
  <div id="timing-info">
    <div><span class="label">Current readyState:</span> <span id="ready-state" class="value">—</span></div>
    <div><span class="label">domContentLoadedEventEnd:</span> <span id="dcl-end" class="value">—</span></div>
    <div><span class="label">DOMContentLoaded fired:</span> <span id="dcl-fired" class="value">—</span></div>
    <div><span class="label">Detection result:</span> <span id="detection-result" class="value">—</span></div>
  </div>
  <div id="log"></div>

  <script>
    // Detect browser
    const ua = navigator.userAgent;
    let browser = "Unknown";
    if (ua.includes("Firefox")) browser = "Firefox";
    else if (ua.includes("Edg/")) browser = "Edge";
    else if (ua.includes("Chrome")) browser = "Chrome";
    else if (ua.includes("Safari")) browser = "Safari";
    if (ua.includes("Mobile")) browser += " (Mobile)";
    document.getElementById("browser").textContent = browser + " — " + navigator.platform;

    let dclFired = false;
    let modulesImported = false;

    // Simple log function
    function loaderLog(msg, type = "") {
      const entry = document.createElement("div");
      entry.className = `log-entry ${type}`;
      entry.textContent = msg;
      document.getElementById("log").appendChild(entry);
    }

    // Function to update timing display
    function updateTimingDisplay() {
      const [navigation] = performance.getEntriesByType("navigation");
      const dclEnd = navigation?.domContentLoadedEventEnd ?? 0;

      document.getElementById("ready-state").textContent = document.readyState;
      document.getElementById("dcl-end").textContent = dclEnd.toFixed(2) + " ms";
      document.getElementById("dcl-fired").textContent = dclFired ? "Yes" : "No";
    }

    // Import modules
    function importModules() {
      if (modulesImported) {
        loaderLog("--- Modules already imported ---", "warning");
        return;
      }
      modulesImported = true;

      const [navigation] = performance.getEntriesByType("navigation");
      const dclEnd = navigation?.domContentLoadedEventEnd ?? 0;
      const readyState = document.readyState;
      const resultEl = document.getElementById("detection-result");

      updateTimingDisplay();
      loaderLog(`--- Import triggered ---`, "detection");
      loaderLog(`    readyState: "${readyState}"`, "sync");
      loaderLog(`    dclFired (actual): ${dclFired}`, "sync");
      loaderLog(`    dclEnd (timing API): ${dclEnd.toFixed(2)} ms`, "sync");

      // This is the key test: does dclEnd > 0 match dclFired?
      const detectedAsFired = dclEnd > 0;
      if (detectedAsFired === dclFired) {
        loaderLog(`    Detection MATCHES actual state!`, "detection");
      } else {
        loaderLog(`    Detection MISMATCH! Detected: ${detectedAsFired}, Actual: ${dclFired}`, "dom-event");
      }

      loaderLog("--- Starting dynamic imports ---", "sync");
      document.getElementById("import-btn").disabled = true;

      Promise.all([
        import("./interactivity-api-async.js"),
        import("./module-a-async.js"),
        import("./module-c-async.js"),
        import("./module-e-async.js"),
        import("./module-f-async.js")
      ]).then(() => {
        loaderLog("--- All dynamic imports complete ---", "sync");
        updateTimingDisplay();

        if (dclEnd > 0) {
          resultEl.textContent = "DOMContentLoaded already fired (detected via dclEnd > 0)";
          resultEl.className = "value success";
        } else {
          resultEl.textContent = "DOMContentLoaded not yet complete (dclEnd === 0)";
          resultEl.className = "value warning";
        }
      });
    }

    // Track DOMContentLoaded
    document.addEventListener("DOMContentLoaded", () => {
      dclFired = true;
      loaderLog("--- DOMContentLoaded fired ---", "dom-event");
      updateTimingDisplay();
    });

    // Also track readyState changes
    document.addEventListener("readystatechange", () => {
      loaderLog(`--- readyState changed to: "${document.readyState}" ---`, "post-task");
      updateTimingDisplay();
    });

    // Button handlers
    document.getElementById("import-btn").addEventListener("click", importModules);
    document.getElementById("clear-btn").addEventListener("click", () => {
      document.getElementById("log").innerHTML = "";
      loaderLog("--- Log cleared ---", "sync");
    });

    // Initial state
    updateTimingDisplay();
    loaderLog(`--- Page loaded, readyState: "${document.readyState}" ---`, "sync");

    // Update display periodically
    setInterval(updateTimingDisplay, 100);
  </script>

  <!--
    NOTE: No module scripts here!
    Click the button to manually import modules.
    This allows testing at any document state.
  -->
</body>
</html>
